    <!DOCTYPE html>
    <html lang="en">
    <head>
        <title>MailSense - Sender Dashboard</title>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
        <style>
            .tone-badge {
                font-size: 0.8rem;
                padding: 0.35em 0.65em;
                border-radius: 0.25rem;
            }
            .tone-polite { background-color: #d1e7dd; color: #0f5132; }
            .tone-urgent { background-color: #fff3cd; color: #664d03; }
            .tone-formal { background-color: #cfe2ff; color: #084298; }
            .tone-neutral { background-color: #e2e3e5; color: #41464b; }

            .email-card {
                transition: all 0.3s;
                border-left: 4px solid transparent;
            }
            .email-card:hover {
                transform: translateY(-2px);
                box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            }
            .email-card.read {
                border-left-color: #198754;
                opacity: 0.9;
            }
            .email-card.unread {
                border-left-color: #0d6efd;
            }

            #compose-form textarea {
                min-height: 200px;
            }

            .read-status {
                font-size: 0.8rem;
            }
            
            .spam-badge {
                font-size: 0.75rem;
            }
        </style>
    </head>
    <body class="bg-light">
        <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="#">
                    <i class="bi bi-envelope-open me-2"></i> MailSense
                </a>
                <div class="d-flex">
                    <span class="text-white me-3">{{ current_user }}</span>
                    <a href="{{ url_for('logout') }}" class="btn btn-outline-light">
                        <i class="bi bi-box-arrow-right"></i> Logout
                    </a>
                </div>
            </div>
        </nav>

        <div class="container py-4">
            <div class="row">
                <div class="col-md-4">
                    <div class="card mb-4 shadow-sm">
                        <div class="card-header bg-white">
                            <h5 class="mb-0"><i class="bi bi-pencil-square me-2"></i>Compose Email</h5>
                        </div>
                        <div class="card-body">
                            <form id="compose-form">
                                <input type="hidden" id="sender_id" value="{{ current_id }}">
                                <div class="mb-3">
                                    <label class="form-label">To</label>
                                    <input type="email" id="recipient" class="form-control" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Subject</label>
                                    <input type="text" id="subject" class="form-control">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Message</label>
                                    <textarea id="body" class="form-control" required></textarea>
                                </div>
                                <div id="tone-feedback" class="mb-3"></div>
                                <button type="button" id="send-btn" class="btn btn-primary w-100">
                                    <i class="bi bi-send me-2"></i> Send Email
                                </button>
                            </form>
                            <div class="card mb-4 shadow-sm">
  <div class="card-header bg-white">
    <h5 class="mb-0"><i class="bi bi-brain me-2"></i> LLaMA Analysis</h5>
  </div>
  <div class="card-body">
    <button id="analyze-btn" class="btn btn-outline-secondary w-100 mb-3">
      <i class="bi bi-search"></i> Analyze with TinyLLaMA
    </button>
    <div id="llama-result" style="display:none;">
      <div class="mb-2">
        <strong>Tone:</strong>
        <span id="llama-tone" class="tone-badge">â€”</span>
      </div>
      <div class="mb-2">
        <strong>Spam:</strong>
        <span id="llama-spam" class="badge">â€”</span>
      </div>
      <div class="mb-2">
        <strong>Raw Tone Response:</strong>
        <pre id="llama-tone-raw" class="bg-light p-2 rounded small text-muted"></pre>
      </div>
      <div>
        <strong>Raw Spam Response:</strong>
        <pre id="llama-spam-raw" class="bg-light p-2 rounded small text-muted"></pre>
      </div>
    </div>
  </div>
</div>

                        </div>
                    </div>
                </div>

                <div class="col-md-8">
                    <div class="card shadow-sm">
                        <div class="card-header bg-white d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="bi bi-envelope-paper me-2"></i>Sent Emails</h5>
                            <div>
                                <button id="refresh-btn" class="btn btn-sm btn-outline-primary me-2">
                                    <i class="bi bi-arrow-clockwise"></i> Refresh
                                </button>
                                <a href="{{ url_for('received_emails') }}" class="btn btn-sm btn-primary">
                                    <i class="bi bi-inbox"></i> Inbox
                                </a>
                            </div>
                        </div>
                        <div class="card-body">
                            <!-- In the emails list section -->
                            <div id="emails-list">
                                {% for email in emails %}
                                <div class="email-card card mb-3 {% if email[5] %}read{% else %}unread{% endif %}" data-email-id="{{ email[0] }}">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <h6 class="card-title">{{ email[2] or '(No subject)' }}</h6>
                                            <span class="text-muted small">{{ email[4] }}</span>
                                        </div>
                                        <p class="card-text text-muted mb-2">To: {{ email[1] }}</p>
                                        <p class="card-text">{{ email[3]|truncate(150) }}</p>
                                        <div class="d-flex flex-wrap align-items-center gap-2">
                                            <span class="tone-badge tone-{{ email[7].lower() if email[7] else 'neutral' }}">
                                                {{ email[7] or 'Neutral' }}
                                            </span>
                                            {% if email[6] %}
                                            <span class="badge bg-danger spam-badge">
                                                <i class="bi bi-exclamation-triangle-fill"></i> SPAM
                                            </span>
                                            {% endif %}
                                            <span class="read-status ms-auto">
                                                {% if email[5] %}
                                                <i class="bi bi-check-circle-fill text-success"></i> Read at {{ email[5] }}
                                                {% else %}
                                                <i class="bi bi-circle text-primary"></i> Unread
                                                {% endif %}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                                {% else %}
                                <div class="text-center py-5">
                                    <i class="bi bi-envelope-open text-muted" style="font-size: 3rem;"></i>
                                    <h5 class="mt-3 text-muted">No sent emails yet</h5>
                                    <p class="text-muted">Send your first email using the compose form</p>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
  const API_BASE = window.location.origin;

  document.addEventListener('DOMContentLoaded', () => {
    // Tone detection
    

    // Send email
    document.getElementById('send-btn').addEventListener('click', async () => {
      const recipient = document.getElementById('recipient').value;
      const subject = document.getElementById('subject').value;
      const body = document.getElementById('body').value;

      if (!recipient || !body) {
        alert('Recipient and message body are required');
        return;
      }

      try {
        const response = await fetch(`${API_BASE}/send`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            sender_id: {{ current_id }},
            recipient: recipient,
            subject: subject,
            body: body,
          })
        });

        const result = await response.json();

        if (response.ok) {
          alert(`Email sent successfully! ${result.is_spam ? '(Marked as spam)' : ''}`);
          document.getElementById('compose-form').reset();
          document.getElementById('tone-feedback').innerHTML = '';
          location.reload();
        } else {
          throw new Error(result.message || 'Failed to send email');
        }
      } catch (error) {
        alert(`Error: ${error.message}`);
      }
    });

    // Refresh emails
    document.getElementById('refresh-btn').addEventListener('click', () => {
      location.reload();
    });

    // Auto-refresh read status every 30 seconds
    setInterval(async () => {
      try {
        const response = await fetch(`${API_BASE}/sent_emails?sender_id={{ current_id }}`);
        const emails = await response.json();

        emails.forEach(email => {
          const emailElement = document.querySelector(`.email-card[data-email-id="${email.id}"]`);
          if (emailElement) {
            const readStatus = emailElement.querySelector('.read-status');
            if (email.opened_at) {
              emailElement.classList.remove('unread');
              emailElement.classList.add('read');
              const readDate = new Date(email.opened_at);
              readStatus.innerHTML = `<i class="bi bi-check-circle-fill text-success"></i> Read at ${readDate.toLocaleString()}`;
            }
          }
        });
      } catch (error) {
        console.error('Error refreshing email status:', error);
      }
    }, 30000);

    // ðŸ”¥ LLaMA Analysis
    document.getElementById('analyze-btn').addEventListener('click', async () => {
      const body = document.getElementById('body').value.trim();
      if (!body) {
        alert('Please write an email body first.');
        return;
      }

      try {
        const toneRes = await fetch(`${API_BASE}/llama_generate_tone`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ text: body })
        });

        const spamRes = await fetch(`${API_BASE}/llama_generate_spam`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ text: body })
        });

        const toneData = await toneRes.json();
        const spamData = await spamRes.json();

        const tone = toneData.tone || 'unknown';
        const spam = spamData.spam === true ? 'Yes' : 'No';

        // Update frontend
        document.getElementById('llama-result').style.display = 'block';
        document.getElementById('llama-tone').textContent = tone.charAt(0).toUpperCase() + tone.slice(1);
        document.getElementById('llama-tone').className = `tone-badge tone-${tone}`;
        document.getElementById('llama-spam').textContent = spam;
        document.getElementById('llama-spam').className = `badge ${spam === 'Yes' ? 'bg-danger' : 'bg-success'}`;

        // Show raw responses
        document.getElementById('llama-tone-raw').textContent = toneData.raw || '';
        document.getElementById('llama-spam-raw').textContent = spamData.raw || '';
      } catch (err) {
        console.error('LLaMA analysis failed:', err);
        alert('Error analyzing email with LLaMA');
      }
    });
  });
</script>


    </body>
    </html>